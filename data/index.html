<!--https://github.com/Yuezi32/flipClock-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Flipper</title>
</head>

<body>
<div class="single-demo">
    <div class="btn-con">
        <button id="btn1">扫描</button>
        <button id="btn2">校准</button>
        <button id="btn3">导入</button>
        <input type="file" name="upload" id="upload" style="display: none;"/>
        <button id="btn4">导出</button>
    </div>
    <div class="btn-con">
        <button id="btn5">翻+1</button>
        <button id="btn6">翻+2</button>
        <button id="btn7">翻+3</button>
        <button id="btn8">翻+4</button>
    </div>
</div>
<div class="clock" id="clock">

</div>
</body>
<script>
    let chosen_index = 0 // chosen unit index, not addr
    let flip_pos = []
    let zero_pos = new Map()
    let addr_map = new Map()
    let contents = []
    let flip_el = []

    var btn1 = document.getElementById('btn1')
    var btn2 = document.getElementById('btn2')
    var btn3 = document.getElementById('btn3')
    var btn4 = document.getElementById('btn4')
    var btn5 = document.getElementById('btn5')
    var btn6 = document.getElementById('btn6')

    function createAndDownloadFile(fileName, content) {
        const aTag = document.createElement('a');
        const blob = new Blob([content]);
        aTag.download = fileName;
        aTag.href = URL.createObjectURL(blob);
        aTag.click();
        URL.revokeObjectURL(blob);
    }

    function parseConfig(content) {
        if (content === "") return


        flip_pos = []
        zero_pos = new Map()
        contents = []
        flip_el = []
        addr_map = new Map()
        let result = content.split("\n")
        let i = 0
        while (true) {
            let line = result[i++]
            if (line === "-1") break

            if (line === "contents") {
                let num = parseInt(result[i++])
                while (num--) {
                    let one_flip_content = []
                    for (let j = 0; j < 40; j++) {
                        one_flip_content.push(result[i++].split(' ')[1])
                    }
                    contents.push(one_flip_content)
                }
            }

            if (line === "addr_map") {
                let num = parseInt(result[i++])
                while (num--) {
                    const [addr, index] = result[i++].split(' ')
                    addr_map.set(parseInt(addr), parseInt(index))
                }
            }

            if (line === "zero_pos") {
                let num = parseInt(result[i++])
                if (num === 0) {
                    for (let addr of addr_map.keys()) {
                        zero_pos.set(parseInt(addr), 0)
                    }
                } else {
                    while (num--) {
                        const [addr, pos] = result[i++].split(' ')
                        zero_pos.set(parseInt(addr), parseInt(pos))
                    }
                }
            }
        }

        fresh()
    }

    document.getElementById('upload').addEventListener('change', function () {
            if (this.files.length === 0) {
                return
            }

            const reader = new FileReader();
            reader.readAsText(this.files[0]);

            reader.onload = () => {
                let result = reader.result
                const data = {data: result}

                fetch("/upload_config", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data)
                })
                    .then(res => res.json())
                    .then(res => {
                        // console.log(res)
                        parseConfig(res.data)
                    })
            }

        }
    )

    btn2.addEventListener('click', function () {
        if (contents.length === 0) return

        let addr;
        for (let item of addr_map) {
            if (item[1] === chosen_index) addr = item[0]
        }

        fetch(`/adjust?addr=${addr}`)
            .then(res => res.json())
            .then(res => {
                console.log(res)
            })
    })

    btn3.addEventListener('click', function () {
        let up = document.getElementById('upload');
        up.click();
    })

    btn4.addEventListener('click', function () {
        fetch("/read_config",)
            .then(res => res.json())
            .then(res => {
                const content = res.data
                createAndDownloadFile("config_backup", content)
            })
    })

    btn5.addEventListener('click', function () {
        flipDown(chosen_index);
    })

    document.addEventListener('DOMContentLoaded', function () {
        fetch("/read_config")
            .then(res => res.json())
            .then(res => {
                parseConfig(res.data)
            })

    });

    function set_style(ch, node) {
        if (ch.startsWith("http")) {
            node.setAttribute("data-attr", "")
            node.style.setProperty("--imgurl", `url("${ch}")`)
        } else if (ch === "blank") {
            node.setAttribute("data-attr", "")
            node.style.setProperty("--imgurl", `#ffffff`)
        } else {
            node.setAttribute("data-attr", ch)
            node.style.setProperty("--imgurl", `#ffffff`)
        }
    }

    function fresh() {
        flip_pos = []
        if (contents.length === 0) return

        const clock = document.getElementById('clock');
        const flips = document.getElementsByClassName("flip")
        Array.from(flips).map(node => clock.removeChild(node))

        const _ = Array.from(addr_map.values())
        contents = contents.map((v, i) => {
            if (_.includes(i)) {
                flip_pos.push(0)
                return v
            }
        })
        contents = contents.filter(i => i)

        for (let i = 0; i < flip_pos.length; i++) {
            const ch = contents[chosen_index][flip_pos[chosen_index]];

            const outer = document.createElement('div')
            outer.setAttribute("class", "flip down")

            const front = document.createElement('div')
            front.setAttribute("class", "digital front")
            set_style(ch, front);

            const back = document.createElement('div')
            back.setAttribute("class", "digital back")

            outer.appendChild(front)
            outer.appendChild(back)
            outer.addEventListener('click', function () {
                const _prev_chosen_node = flip_el[chosen_index];
                _prev_chosen_node.classList.remove("chosen")
                chosen_index = i
                const _now_chosen_node = flip_el[chosen_index];
                _now_chosen_node.classList.add("chosen")
            })

            outer.addEventListener("wheel", function (event) {
                if (event.deltaY > 0) {
                    flipDown(i)
                }
            })

            flip_el.push(outer)
            clock.appendChild(outer);
        }
        flip_el[chosen_index].classList.add("chosen")
    }

    let isFlipping = false

    // 向下翻转+1
    function flipDown(_chosen_node_index) {
        // 如果处于翻转中，则不执行
        if (isFlipping) {
            return false
        }

        const chosen_node = flip_el[_chosen_node_index];

        // 设置前牌的文字
        const front = chosen_node.firstChild
        const ch = contents[_chosen_node_index][flip_pos[_chosen_node_index]]

        set_style(ch, front)

        // 计算后牌文字（越界判断）
        let next_ch
        if (flip_pos[_chosen_node_index] + 1 === contents[_chosen_node_index].length) {
            next_ch = contents[_chosen_node_index][0];
            flip_pos[_chosen_node_index] = 0;
        } else {
            next_ch = contents[_chosen_node_index][++flip_pos[_chosen_node_index]]
        }

        // 设置后牌的文字
        const back = chosen_node.lastChild
        set_style(next_ch, back)

        // 添加go，执行翻转动画
        chosen_node.setAttribute('class', `flip down go chosen`)

        // 当翻转态设置为true
        isFlipping = true
        // 翻转结束后，恢复状态
        setTimeout(function () {
            // 去掉go
            chosen_node.setAttribute('class', `flip down ${chosen_index === _chosen_node_index ? 'chosen' : ''}`)
            // 当翻转态设置为false
            isFlipping = false

            // 设置前牌文字为+1后的数字
            set_style(next_ch, front)

        }, 300)
    }


</script>
<style>
    .single-demo {
        margin: 50px auto;
        padding: 30px;
        width: 600px;
        text-align: center;
        border: solid 1px #999;
    }

    .flip {
        display: inline-block;
        position: relative;
        width: 140px;
        height: 210px;
        line-height: 210px;
        margin: 10px;
        border: solid 1px #000;
        border-radius: 15px;
        background: #fff;
        font-size: 120px;
        color: #fff;
        box-shadow: 0 0 6px rgba(0, 0, 0, .5);
        text-align: center;
    }

    .flip.chosen {
        box-shadow: 5px 5px 10px 0 rgb(6 52 135);
    }

    .flip .digital:before,
    .flip .digital:after {
        content: attr(data-attr);
        position: absolute;
        left: 0;
        right: 0;
        background: var(--imgurl, "#fff");
        background-size: cover;
        color: black;
        overflow: hidden;
        box-sizing: border-box;
        border: solid 1px #000;
    }

    .flip .digital:before {
        top: 0;
        bottom: 50%;
        border-radius: 10px 10px 0 0;
        border-bottom: solid 1px #666;
        background-position-y: top;
    }

    .flip .digital:after {
        top: 50%;
        bottom: 0;
        background-position-y: bottom;
        border-radius: 0 0 10px 10px;
        line-height: 0;
    }

    /*向下翻*/
    .flip.down .front:before {
        z-index: 3;
    }

    .flip.down .back:after {
        z-index: 2;
        transform-origin: 50% 0%;
        transform: perspective(250px) rotateX(180deg);
    }

    .flip.down .front:after,
    .flip.down .back:before {
        z-index: 1;
    }

    .flip.down.go .front:before {
        transform-origin: 50% 100%;
        animation: frontFlipDown 0.3s ease-in-out both;
        box-shadow: 0 -2px 6px rgba(255, 255, 255, 0.3);
        backface-visibility: hidden;
    }

    .flip.down.go .back:after {
        animation: backFlipDown 0.3s ease-in-out both;
    }

    /*向上翻*/
    .flip.up .front:after {
        z-index: 3;
    }

    .flip.up .back:before {
        z-index: 2;
        transform-origin: 50% 100%;
        transform: perspective(250px) rotateX(-180deg);
    }

    .flip.up .front:before,
    .flip.up .back:after {
        z-index: 1;
    }

    .flip.up.go .front:after {
        transform-origin: 50% 0;
        animation: frontFlipUp 0.3s ease-in-out both;
        box-shadow: 0 2px 6px rgba(255, 255, 255, 0.3);
        backface-visibility: hidden;
    }

    .flip.up.go .back:before {
        animation: backFlipUp 0.3s ease-in-out both;
    }

    @keyframes frontFlipDown {
        0% {
            transform: perspective(250px) rotateX(0deg);
        }

        100% {
            transform: perspective(250px) rotateX(-180deg);
        }
    }

    @keyframes backFlipDown {
        0% {
            transform: perspective(250px) rotateX(180deg);
        }

        100% {
            transform: perspective(250px) rotateX(0deg);
        }
    }


    @keyframes frontFlipUp {
        0% {
            transform: perspective(250px) rotateX(0deg);
        }

        100% {
            transform: perspective(250px) rotateX(180deg);
        }
    }

    @keyframes backFlipUp {
        0% {
            transform: perspective(250px) rotateX(-180deg);
        }

        100% {
            transform: perspective(250px) rotateX(0deg);
        }
    }


    .clock {
        text-align: center;
        margin-bottom: 200px;
    }

    .clock em {
        display: inline-block;
        line-height: 102px;
        font-size: 66px;
        font-style: normal;
        vertical-align: top;
    }
</style>

</html>